{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto py-8">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Аналитическая панель</h1>
        <span class="bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full uppercase tracking-wide">
            Admin Area
        </span>
    </div>

    <!-- 1. KPI CARDS -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <p class="text-gray-500 text-sm font-medium uppercase">Всего пользователей</p>
            <p class="text-4xl font-bold text-gray-800 mt-2">{{ kpi.users }}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <p class="text-gray-500 text-sm font-medium uppercase">Создано опросов</p>
            <p class="text-4xl font-bold text-blue-600 mt-2">{{ kpi.surveys }}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <p class="text-gray-500 text-sm font-medium uppercase">Всего ответов</p>
            <p class="text-4xl font-bold text-green-600 mt-2">{{ kpi.responses }}</p>
        </div>
    </div>

    <!-- 2. CHARTS ROW 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Динамика (Line Chart) -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <!-- Шапка: Заголовок + Контролы -->
            <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center mb-4 gap-4">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2 whitespace-nowrap">
                    Активность
                    <!-- Спиннер -->
                    <svg id="activity-loader" class="htmx-indicator w-5 h-5 text-blue-600 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </h3>
                
                <!-- Форма фильтрации -->
                <form hx-get="/admin/analytics/activity" 
                      hx-target="#activity-wrapper" 
                      hx-indicator="#activity-loader"
                      class="flex flex-wrap items-center gap-2 w-full xl:w-auto">
                    
                    <div class="relative group">
                        <input type="date" name="start_date" 
                               class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-2 pr-2 py-1.5 cursor-pointer hover:bg-white transition">
                        <div class="absolute -top-3 left-1 bg-white px-1 text-[10px] text-gray-400">От</div>
                    </div>

                    <div class="relative group">
                        <input type="date" name="end_date" 
                               class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-2 pr-2 py-1.5 cursor-pointer hover:bg-white transition">
                        <div class="absolute -top-3 left-1 bg-white px-1 text-[10px] text-gray-400">До</div>
                    </div>

                    <button type="submit" 
                            class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1.5 px-3 rounded-lg transition shadow-sm flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
                        Фильтр
                    </button>
                </form>
            </div>
            
            <!-- Контейнер для графика -->
            <div id="activity-wrapper">
                <!-- Начальная загрузка (include) -->
                {% include "admin/partials/activity_chart.html" %}
            </div>
        </div>

        <!-- Воронка (Bar/Funnel) -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Воронка конверсии</h3>
            <div id="chart-funnel" class="w-full h-80"></div>
        </div>
    </div>

    <!-- 2.5. HEATMAP ROW -->
    <div class="mb-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <!-- Шапка с заголовком и фильтром -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div>
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        Тепловая карта активности
                        <!-- Индикатор загрузки HTMX -->
                        <svg id="heatmap-loader" class="htmx-indicator w-5 h-5 text-blue-600 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </h3>
                    <p class="text-xs text-gray-400 mt-1">В какое время пользователи чаще всего проходят опросы</p>
                </div>
                
                <!-- FILTER SELECT -->
                <div class="relative">
                    <select name="period"
                            hx-get="/admin/analytics/heatmap"
                            hx-target="#heatmap-wrapper"
                            hx-swap="innerHTML"
                            hx-indicator="#heatmap-loader"
                            class="appearance-none bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-3 pr-8 py-2 cursor-pointer hover:bg-white transition">
                        <option value="all" selected>За всё время</option>
                        <option value="year">Текущий год</option>
                        <option value="30d">30 дней</option>
                        <option value="7d">7 дней</option>
                    </select>
                    <!-- Кастомная стрелочка -->
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>
            </div>

            <!-- Сюда HTMX будет загружать график -->
            <div id="heatmap-wrapper">
                 <!-- Первичная загрузка (include) -->
                 {% include "admin/partials/heatmap.html" %}
            </div>
        </div>
    </div>

    <!-- === НОВЫЙ ROW: Демография + Теги === -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- ГРАФИК 1: Демография (НОВЫЙ) -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Активность по возрастным группам</h3>
            <div id="chart-demographics" class="w-full h-80"></div>
        </div>

        <!-- ГРАФИК 2: Интересы (Перенесли сюда, чтобы было красиво 2 колонки) -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Интересы аудитории</h3>
            <div id="chart-tags" class="w-full h-80"></div>
        </div>
    </div>

    <!-- Аномалии (Table) -->
    <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col mb-8">
        <!-- Шапка с фильтром -->
        <div class="p-6 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-white z-20">
            <div>
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <div class="p-1.5 bg-red-50 rounded-lg">
                        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    </div>
                    Подозрительно быстрые

                    <!-- 1. ИНДИКАТОР ЗАГРУЗКИ (СПИННЕР) -->
                    <svg id="anomalies-loader" class="htmx-indicator w-5 h-5 text-blue-600 animate-spin ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </h3>
                <p class="text-xs text-gray-400 mt-1 ml-1">Быстрее чем (Среднее - 1.5σ)</p>
            </div>
            
            <!-- ФИЛЬТР -->
            <div class="relative w-full sm:w-64">
                <select name="survey_id" 
                        hx-get="/admin/analytics/anomalies" 
                        hx-target="#anomalies-container" 
                        hx-swap="outerHTML"
                        hx-indicator="#anomalies-loader"
                        class="w-full pl-3 pr-10 py-2 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50 hover:bg-white transition-colors cursor-pointer appearance-none">
                    <option value="">Все опросы ({{ all_surveys|length }})</option>
                    {% for s in all_surveys %}
                    <option value="{{ s.survey_id }}" {% if selected_survey_id == s.survey_id %}selected{% endif %}>
                        {{ s.title }}
                    </option>
                    {% endfor %}
                </select>
                <!-- Стрелочка кастомная -->
                <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
            </div>
        </div>

        <!-- Контейнер таблицы (сюда HTMX подгрузит anomalies_table.html) -->
        {% include "admin/partials/anomalies_table.html" %}
        
    </div>

</div>

<!-- Инициализация графиков Plotly -->
<script>
    const fontConfig = {
        family: 'ui-sans-serif, system-ui, sans-serif',
        size: 12,
        color: '#4b5563'
    };

    // Funnel
    const funnelData = {
        x: {{ funnel_data.labels | tojson }},
        y: {{ funnel_data.counts | tojson }}, 
        type: 'bar',
        marker: {
            color: ['#93c5fd', '#3b82f6', '#1e40af'],
            line: { width: 0 }
        },
        text: {{ funnel_data.counts | tojson }}.map(String),
        textposition: 'auto',
        hovertemplate: '<b>%{x}</b><br>Количество: %{y}<extra></extra>'
    };
    Plotly.newPlot('chart-funnel', [funnelData], {
        margin: {t: 10, l: 30, r: 10, b: 30},
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        xaxis: { automargin: true, tickfont: fontConfig },
        yaxis: { automargin: true, tickfont: fontConfig, gridcolor: '#e5e7eb' }
    }, {displayModeBar: false, responsive: true});

    // Tags
    const tagsData = {
        labels: {{ tags_data.labels | tojson }},
        values: {{ tags_data.counts | tojson }},
        type: 'pie',
        hole: 0.5,
        marker: {
            colors: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
        },
        textinfo: 'label+percent',
        textposition: 'outside',
        automargin: true,
        hovertemplate: 'Тег: <b>%{label}</b><br>Ответов: %{value}<extra></extra>'
    };
    Plotly.newPlot('chart-tags', [tagsData], {
        margin: {t: 0, l: 0, r: 0, b: 0},
        showlegend: false,
        paper_bgcolor: 'rgba(0,0,0,0)',
    }, {displayModeBar: false, responsive: true});

    // Демография
    const demographicsData = {
        x: {{ demographics.labels | tojson }},
        y: {{ demographics.counts | tojson }},
        type: 'bar',
        marker: {
            color: '#8b5cf6', // Фиолетовый цвет
            opacity: 0.8,
            line: { width: 0 }
        },
        text: {{ demographics.counts | tojson }}.map(String),
        textposition: 'auto',
    };
    
    const layoutDemo = {
        margin: {t: 10, l: 30, r: 10, b: 30},
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        xaxis: {
            title: 'Возрастная группа',
            automargin: true,
        },
        yaxis: {
            title: 'Кол-во ответов',
            automargin: true,
        }
    };

    Plotly.newPlot('chart-demographics', [demographicsData], layoutDemo, {displayModeBar: false, responsive: true});
</script>

<style>
    /* Тонкий скроллбар для Webkit (Chrome, Safari) */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 20px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: #94a3b8;
    }

    /* По умолчанию скрываем спиннер и пропускаем клики сквозь него */
    .htmx-indicator {
        opacity: 0;
        pointer-events: none;
        transition: opacity 200ms ease-in;
    }
    /* Когда HTMX добавляет класс htmx-request, показываем спиннер и блокируем клики */
    .htmx-request .htmx-indicator,
    .htmx-request.htmx-indicator {
        opacity: 1;
        pointer-events: auto;
    }
</style>
{% endblock %}