<div class="fixed inset-0 z-[100]" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Фон -->
    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 transition-opacity backdrop-blur-sm" 
         onclick="document.getElementById('modal-container').innerHTML = ''"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <!-- Окно -->
            <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-gray-100">
                <form hx-post="/admin/tables/update-row/{{ table_name }}/{{ pk_val }}" 
                      hx-target="#modal-error-block">
                    <div class="bg-white px-6 py-6 max-h-[80vh] overflow-y-auto custom-scrollbar">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900" id="modal-title">Редактирование записи</h3>
                            <button type="button" onclick="document.getElementById('modal-container').innerHTML = ''" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                        <!-- Блок для ошибок -->
                        <div id="modal-error-block"></div>
                        <div class="space-y-4">
                            {% for col in columns %}
                                {% set col_name = col['name'] %}
                                {% set col_type = col['type'] | string %}
                                {% set val = row[col_name] %}
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        {{ col_name }}
                                        {% if col_name == pk_col %}<span class="text-yellow-600 text-xs ml-1">(PK)</span>{% endif %}
                                    </label>

                                    {% if col_name == pk_col %}
                                        <!-- PK Readonly -->
                                        <input type="text" value="{{ val }}" disabled 
                                               class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-500 cursor-not-allowed">
                                    
                                    <!-- !!! ВЫПАДАЮЩИЕ СПИСКИ (Добавлено) !!! -->
                                    {% elif col_name in options_map %}
                                        <select name="{{ col_name }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                            <option value="NULL" {% if val is none %}selected{% endif %}>NULL (Не выбрано)</option>
                                            
                                            {% for opt in options_map[col_name] %}
                                                <!-- Проверяем тип опции: кортеж (FK) или строка (Enum) -->
                                                {% if opt is iterable and opt is not string %}
                                                    <!-- FK: opt[0]=id, opt[1]=name. Сравниваем ID с текущим значением val -->
                                                    <option value="{{ opt[0] }}" {% if val == opt[0] %}selected{% endif %}>
                                                        {{ opt[1] }} (ID: {{ opt[0] }})
                                                    </option>
                                                {% else %}
                                                    <!-- Enum: opt=строка. Сравниваем строки -->
                                                    <option value="{{ opt }}" {% if val == opt %}selected{% endif %}>
                                                        {{ opt }}
                                                    </option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>

                                    <!-- !!! ПАРОЛЬ (Добавлено) !!! -->
                                    {% elif 'password' in col_name or 'hash' in col_name %}
                                        <input type="password" name="{{ col_name }}" autocomplete="new-password"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                               placeholder="Введите новый пароль, если хотите изменить">

                                    {% elif 'TEXT' in col_type or ('VARCHAR' in col_type and (not col['type'].length or col['type'].length > 100)) %}
                                        <!-- Textarea для длинных текстов -->
                                        <textarea name="{{ col_name }}" rows="3" 
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">{{ val if val is not none else '' }}</textarea>
                                    
                                    {% elif 'DATE' in col_type %}
                                        <input type="date" name="{{ col_name }}" value="{{ val }}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                                    
                                    {% elif 'BOOLEAN' in col_type %}
                                        <!-- Select для Boolean -->
                                        <select name="{{ col_name }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white">
                                            <option value="true" {% if val == True %}selected{% endif %}>True</option>
                                            <option value="false" {% if val == False %}selected{% endif %}>False</option>
                                            <option value="NULL" {% if val is none %}selected{% endif %}>NULL</option>
                                        </select>
                                    
                                    {% else %}
                                        <!-- Обычный Input -->
                                        <input type="text" name="{{ col_name }}" value="{{ val if val is not none else '' }}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
                                               placeholder="NULL">
                                    {% endif %}
                                    
                                    <p class="text-xs text-gray-400 mt-1">{{ col_type }}</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="bg-gray-50 px-6 py-4 flex flex-row-reverse gap-3 border-t border-gray-100">
                        <button type="submit" class="inline-flex w-full justify-center rounded-lg bg-blue-600 px-5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:w-auto transition transform active:scale-95">
                            Сохранить изменения
                        </button>
                        <button type="button" onclick="document.getElementById('modal-container').innerHTML = ''" class="mt-3 inline-flex w-full justify-center rounded-lg bg-white px-5 py-2.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto transition">
                            Отмена
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>