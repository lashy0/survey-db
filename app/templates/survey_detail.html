{% extends "base.html" %}

{% block content %}
<div class="max-w-3xl mx-auto py-8">
    
    <!-- 1. –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è (–í–µ—Ä—Ö–Ω–∏–π –±–∞–Ω–Ω–µ—Ä) -->
    {% if existing_response and not is_readonly %}
    <div class="mb-6 bg-green-50 border-l-4 border-green-500 text-green-800 p-4 rounded shadow-sm flex items-start gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div>
            <p class="font-bold">–û—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</p>
            <p class="text-sm mt-1">–í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∏—Ö –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è, –ø–æ–∫–∞ –æ–ø—Ä–æ—Å –∞–∫—Ç–∏–≤–µ–Ω.</p>
            <p class="text-xs text-green-600 mt-2">
                –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 
                {% if existing_response.completed_at %}
                    {{ existing_response.completed_at.strftime('%d.%m.%Y %H:%M') }}
                {% else %}
                    —Ç–æ–ª—å–∫–æ —á—Ç–æ
                {% endif %}
            </p>
        </div>
    </div>
    {% endif %}

    <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ Read-Only -->
    {% if is_readonly %}
    <div class="mb-6 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded shadow-sm">
        <p class="font-bold">–û–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω</p>
        <p class="text-sm">–ü—Ä–∏–µ–º –æ—Ç–≤–µ—Ç–æ–≤ –∑–∞–∫—Ä—ã—Ç. –í—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ —Ä–µ–∂–∏–º —á—Ç–µ–Ω–∏—è.</p>
    </div>
    {% endif %}

    <!-- –®–∞–ø–∫–∞ –æ–ø—Ä–æ—Å–∞ -->
    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 mb-6">
        <div class="flex flex-wrap gap-2 mb-4">
            {% for tag in survey.tags %}
            <span class="bg-blue-50 text-blue-600 text-xs font-semibold px-3 py-1 rounded-full">
                #{{ tag.name }}
            </span>
            {% endfor %}
        </div>
        
        <div class="flex justify-between items-start mb-3">
            <h1 class="text-3xl font-bold text-gray-900 pr-4">{{ survey.title }}</h1>
            
            <!-- –ö–ù–û–ü–ö–ê (–í–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä—É –∏–ª–∏ –∞–¥–º–∏–Ω—É) -->
            {% if user and (user.role == 'admin' or user.user_id == survey.author_id) %}
            <a href="/surveys/{{ survey.survey_id }}/results" 
               class="shrink-0 flex items-center gap-2 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium transition text-sm border border-indigo-200 shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
            </a>
            {% endif %}
        </div>
        <p class="text-gray-600 text-lg leading-relaxed">{{ survey.description }}</p>
        
        <div class="mt-6 flex items-center gap-4 text-sm text-gray-500">
            <span>üìÖ {{ survey.created_at.strftime('%d.%m.%Y') }}</span>
            <span class="flex items-center gap-1">
                üë§ –ê–≤—Ç–æ—Ä: <span class="font-medium text-gray-700">{{ survey.author.full_name if survey.author else "–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω" }}</span>
            </span>
        </div>
    </div>

    {% if not user %}
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded shadow-sm flex items-center justify-between">
            <p class="text-blue-700 font-medium">–ß—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ –≤ –æ–ø—Ä–æ—Å–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç.</p>
            <a href="/login" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">–í–æ–π—Ç–∏</a>
        </div>
    {% endif %}

    <!-- –§–æ—Ä–º–∞ -->
    <form id="survey-form" action="/surveys/{{ survey.survey_id }}/submit" method="post" class="space-y-6">
        <input type="hidden" name="csrf_token" value="{{ request.state.csrf_token }}">
        
        {% for question in survey.questions %}
        {% set user_answers_list = existing_answers.get(question.question_id, []) %}
        
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden transition hover:shadow-md group">
            <div class="absolute top-0 right-0 bg-gray-50 text-gray-400 text-xs font-bold px-3 py-1 rounded-bl-xl border-l border-b border-gray-100">
                #{{ question.position }}
            </div>

            <h3 class="text-lg font-bold text-gray-800 mb-4 pr-8">
                {{ question.question_text }}
                {% if question.is_required %}<span class="text-red-500">*</span>{% endif %}
            </h3>

            <div class="space-y-3">
                <!-- SINGLE CHOICE -->
                {% if question.question_type == 'single_choice' %}
                    {% for option in question.options %}
                    <label class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer transition relative overflow-hidden">
                        <input type="radio" name="q_{{ question.question_id }}" value="{{ option.option_id }}" 
                               class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 survey-input"
                               {% if option.option_id in user_answers_list %}checked{% endif %}
                               {% if question.is_required %}required{% endif %}
                               {% if is_readonly %}disabled{% endif %}>
                        <span class="ml-3 text-gray-700">{{ option.option_text }}</span>
                        <!-- –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ -->
                        {% if option.option_id in user_answers_list %}
                        <div class="absolute inset-0 bg-blue-50/50 pointer-events-none border-2 border-blue-100 rounded-lg"></div>
                        {% endif %}
                    </label>
                    {% endfor %}

                <!-- MULTIPLE CHOICE -->
                {% elif question.question_type == 'multiple_choice' %}
                    {% for option in question.options %}
                    <label class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer transition relative">
                        <input type="checkbox" name="q_{{ question.question_id }}" value="{{ option.option_id }}" 
                               class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded survey-input"
                               {% if option.option_id in user_answers_list %}checked{% endif %}
                               {% if is_readonly %}disabled{% endif %}>
                        <span class="ml-3 text-gray-700">{{ option.option_text }}</span>
                        {% if option.option_id in user_answers_list %}
                        <div class="absolute inset-0 bg-blue-50/50 pointer-events-none border-2 border-blue-100 rounded-lg"></div>
                        {% endif %}
                    </label>
                    {% endfor %}

                <!-- RATING -->
                {% elif question.question_type == 'rating' %}
                    <div class="flex gap-4 items-center justify-center sm:justify-start">
                        {% for option in question.options %}
                        <label class="cursor-pointer group/rating">
                            <input type="radio" name="q_{{ question.question_id }}" value="{{ option.option_id }}" class="peer sr-only survey-input"
                                   {% if option.option_id in user_answers_list %}checked{% endif %}
                                   {% if question.is_required %}required{% endif %}
                                   {% if is_readonly %}disabled{% endif %}>
                            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold transition border-2 
                                        {% if option.option_id in user_answers_list %}
                                            border-blue-300 bg-blue-50 text-blue-600 ring-2 ring-offset-1 ring-blue-100
                                        {% else %}
                                            border-gray-300 text-gray-600
                                        {% endif %}
                                        group-hover:border-blue-400
                                        peer-checked:border-blue-600 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:ring-0">
                                {{ option.option_text }}
                            </div>
                        </label>
                        {% endfor %}
                    </div>

                <!-- TEXT ANSWER -->
                {% elif question.question_type == 'text_answer' %}
                    <textarea name="q_{{ question.question_id }}" rows="3" 
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition survey-input"
                              placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..."
                              {% if question.is_required %}required{% endif %}
                              {% if is_readonly %}disabled{% endif %}>{{ user_answers_list[0] if user_answers_list else '' }}</textarea>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        {% if not is_readonly %}
        <div class="flex justify-end pt-8 pb-4">
            {% if user %}
                <button type="submit" id="submit-btn" disabled
                        class="group relative flex items-center justify-center bg-green-600 text-white px-10 py-4 rounded-xl font-bold text-lg shadow-lg 
                            transition-all duration-200
                            disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none bg-gray-400">
                    <!-- –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ -->
                    <span id="btn-text">
                        {% if existing_response %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% else %}–ó–∞–≤–µ—Ä—à–∏—Ç—å –æ–ø—Ä–æ—Å{% endif %}
                    </span>

                    <!-- –°–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                    <span id="btn-spinner" class="absolute hidden">
                        <svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                </button>
            {% else %}
                <a href="/login" class="bg-gray-400 text-white px-10 py-4 rounded-xl font-bold text-lg cursor-pointer">
                    –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å
                </a>
            {% endif %}
        </div>
        {% endif %}
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('survey-form');
        const submitBtn = document.getElementById('submit-btn');
        const btnText = document.getElementById('btn-text');
        const btnSpinner = document.getElementById('btn-spinner');
        
        // –§–ª–∞–≥: –±—ã–ª–∏ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–µ?
        let isDirty = false;
        // –§–ª–∞–≥: –Ω–∞–∂–∞–ª–∏ –ª–∏ –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏? (—á—Ç–æ–±—ã –Ω–µ –ø—É–≥–∞—Ç—å –ø—Ä–∏ —Å–∞–±–º–∏—Ç–µ)
        let isSubmitting = false;

        if (!form) return; // –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–∂–∏–º "—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ"

        // --- 1. –£–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π (Dirty Check) ---
        const inputs = form.querySelectorAll('.survey-input');

        function checkChanges() {
            let hasChanges  = false;
            
            inputs.forEach(input => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    // –î–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ –∏ —Ä–∞–¥–∏–æ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º checked —Å defaultChecked
                    if (input.checked !== input.defaultChecked) {
                        hasChanges  = true;
                    }
                } else {
                    // –î–ª—è —Ç–µ–∫—Å—Ç–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º value —Å defaultValue
                    if (input.value !== input.defaultValue) {
                        hasChanges  = true;
                    }
                }
            });

            isDirty = hasChanges;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
            if (isDirty) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-gray-400');
                submitBtn.classList.add('bg-green-600', 'hover:bg-green-700', 'hover:-translate-y-0.5');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('bg-gray-400');
                submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700', 'hover:-translate-y-0.5');
            }
        }

        // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ –≤—Å–µ—Ö –∏–Ω–ø—É—Ç–∞—Ö
        form.addEventListener('input', checkChanges);
        form.addEventListener('change', checkChanges);

        if (submitBtn) {
            submitBtn.addEventListener('click', () => {
                isSubmitting = true;
            });
        }

        // 2. –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–∫—Ä—ã—Ç–∏—è –≤–∫–ª–∞–¥–∫–∏ (Native Browser Alert)
        window.addEventListener('beforeunload', (e) => {
            // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ò –º—ã –Ω–µ –Ω–∞–∂–∏–º–∞–ª–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
            if (isDirty && !isSubmitting) {
                e.preventDefault();
                e.returnValue = ''; // –°—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –≤—ã–∑–æ–≤–∞ –¥–∏–∞–ª–æ–≥–∞ –±—Ä–∞—É–∑–µ—Ä–∞
            }
        });

        // --- 2. –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ ---
        form.addEventListener('submit', () => {
            isSubmitting = true; // –î—É–±–ª–∏—Ä—É–µ–º —Ñ–ª–∞–≥ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–∂–∞—Ç—å –¥–≤–∞–∂–¥—ã
            submitBtn.disabled = true;
            submitBtn.classList.add('cursor-wait');
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
            btnText.classList.add('invisible');
            btnSpinner.classList.remove('hidden');
        });
    });
</script>
{% endblock %}