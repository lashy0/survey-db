<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 relative group question-block transition-all duration-200 hover:border-blue-300 hover:shadow-sm" id="question-{{ index }}">
    
    <!-- Скрытое поле для порядка -->
    <input type="hidden" name="questions[{{ index }}][position]" class="question-position" value="0">

    <!-- Хэндл для перетаскивания (Drag Handle) -->
    <div class="drag-handle absolute top-4 left-4 cursor-move text-gray-300 hover:text-gray-600 p-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
        </svg>
    </div>

    <!-- Кнопка удаления -->
    <button type="button" onclick="this.closest('.question-block').remove(); validateForm();" 
            class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
    </button>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 pl-8"> <!-- pl-8 отступ для иконки -->
        <!-- Текст вопроса (шире) -->
        <div class="md:col-span-8">
            <label class="block text-sm font-medium text-gray-700 mb-1">Текст вопроса</label>
            <input type="text" name="questions[{{ index }}][text]" required
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 question-input"
                   oninput="validateForm()"
                   placeholder="Например: Ваш любимый цвет?">
        </div>
        
        <!-- Тип вопроса -->
        <div class="md:col-span-4 flex gap-2">
            <div class="flex-grow">
                <label class="block text-sm font-medium text-gray-700 mb-1">Тип</label>
                <select name="questions[{{ index }}][type]" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm"
                        onchange="toggleOptions(this, {{ index }})">
                    <option value="single_choice">Один вариант</option>
                    <option value="multiple_choice">Множественный выбор</option>
                    <option value="text_answer">Текстовый ответ</option>
                    <option value="rating">Рейтинг</option>
                </select>
            </div>
            
            <!-- Галочка Обязательно -->
            <div class="flex items-end pb-2">
                <label class="flex items-center gap-2 cursor-pointer text-sm text-gray-600 hover:text-gray-900 select-none">
                    <input type="checkbox" name="questions[{{ index }}][is_required]" checked 
                           class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <span>Обязательный</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Опции -->
    <div id="options-container-{{ index }}" class="pl-12 border-l-2 border-blue-100 space-y-2 ml-2">
        <p class="text-xs text-gray-500 font-semibold uppercase mb-2">Варианты ответов</p>
        
        <div hx-get="/surveys/partials/option?q_index={{ index }}&o_index=0" hx-trigger="load" hx-swap="beforeend"></div>
        <div hx-get="/surveys/partials/option?q_index={{ index }}&o_index=1" hx-trigger="load" hx-swap="beforeend"></div>
    </div>

    <!-- Кнопка добавления варианта (Скрываем если Rating или Text) -->
    <button type="button" 
            id="add-option-btn-{{ index }}"
            class="mt-3 ml-12 text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1"
            hx-get="/surveys/partials/option?q_index={{ index }}"
            hx-vals='js:{"o_index": document.querySelectorAll("#options-container-{{ index }} input").length}'
            hx-target="#options-container-{{ index }}"
            hx-swap="beforeend">
        <span>+ Добавить вариант</span>
    </button>

    <!-- НОВЫЙ БЛОК: Настройки Рейтинга (Скрыт по умолчанию) -->
    <div id="rating-settings-{{ index }}" class="hidden pl-12 ml-2 mt-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Шкала оценки</label>
        <div class="flex gap-4">
            <label class="flex items-center gap-2 cursor-pointer bg-white border border-gray-200 px-4 py-2 rounded-lg hover:border-blue-300 transition">
                <input type="radio" name="questions[{{ index }}][rating_scale]" value="5" checked class="text-blue-600 focus:ring-blue-500">
                <span>от 1 до 5</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer bg-white border border-gray-200 px-4 py-2 rounded-lg hover:border-blue-300 transition">
                <input type="radio" name="questions[{{ index }}][rating_scale]" value="10" class="text-blue-600 focus:ring-blue-500">
                <span>от 1 до 10</span>
            </label>
        </div>
        <p class="text-xs text-gray-400 mt-2">Варианты ответов будут созданы автоматически.</p>
    </div>
</div>

<script>
    function toggleOptions(select, index) {
        const optionsContainer = document.getElementById(`options-container-${index}`);
        const addBtn = document.getElementById(`add-option-btn-${index}`);
        const ratingSettings = document.getElementById(`rating-settings-${index}`);
        
        // Сброс видимости
        optionsContainer.classList.add('hidden');
        addBtn.classList.add('hidden');
        ratingSettings.classList.add('hidden');

        if (select.value === 'single_choice' || select.value === 'multiple_choice') {
            optionsContainer.classList.remove('hidden');
            addBtn.classList.remove('hidden');
        } else if (select.value === 'rating') {
            ratingSettings.classList.remove('hidden');
        }
        // Для text_answer всё скрыто
    }
</script>