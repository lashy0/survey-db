{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto py-8">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Результаты: {{ survey.title }}</h1>
            <p class="text-gray-500 mt-1">Детальная аналитика по ответам</p>
        </div>
        <div class="flex gap-3">
        <a href="/surveys/{{ survey.survey_id }}/export" 
        class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow-sm font-medium">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Скачать CSV
        </a>
        <a href="/" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50">Назад</a>
    </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- ЛЕВАЯ КАРТОЧКА: Цифры -->
        <div class="bg-indigo-900 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
            <div class="relative z-10">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-indigo-200 text-xs font-bold uppercase tracking-wider">Сравнение показателей</h3>
                    <div class="flex gap-4 text-[10px] uppercase font-bold">
                        <span class="flex items-center gap-1">
                            <div class="w-2.5 h-2.5 bg-indigo-400 rounded-sm"></div> Вы
                        </span>
                        <span class="flex items-center gap-1">
                            <div class="w-0.5 h-2.5 bg-indigo-300 shadow-[0_0_3px_white]"></div> Рынок (Среднее)
                        </span>
                    </div>
                </div>
                
                    
                <div class="space-y-6">
                    {% for b in benchmarks %}
                    <div>
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-sm font-medium text-indigo-100">{{ b.metric_name }}</span>
                            <div class="text-right">
                                <span class="text-lg font-bold text-white">{{ b.survey_value | round(1) }}</span>
                                <span class="text-indigo-300 text-xs ml-1">/ {{ b.category_avg | round(1) }}</span>
                            </div>
                        </div>
                        
                        <!-- Контейнер полоски -->
                        <div class="relative w-full bg-white/10 rounded-full h-3 border border-white/5 flex items-center">
                            
                            <!-- Вертикальная метка СРЕДНЕГО (Рынок) ровно посередине -->
                            <div class="absolute left-1/2 top-0 bottom-0 w-0.5 bg-indigo-300 z-20 shadow-[0_0_5px_white]">
                                <!-- Подпись над меткой (необязательно) -->
                                <span class="absolute -top-4 left-1/2 -translate-x-1/2 text-[8px] text-indigo-300 font-bold uppercase">Avg</span>
                            </div>

                            {# Рассчитываем ширину вашей полоски #}
                            {% set raw_pct = (b.survey_value / (b.category_avg + 0.001) * 50) %}
                            {% set pct = raw_pct if raw_pct < 100 else 100 %}
                            
                            <!-- Ваша полоска -->
                            <div class="bg-gradient-to-r from-indigo-500 to-indigo-300 h-full rounded-full transition-all duration-1000 relative z-10" 
                                style="width: {{ pct }}%">
                                <!-- Блик для красоты -->
                                <div class="absolute inset-0 bg-white/20 w-full h-0.5 top-0.5 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- ПРАВАЯ КАРТОЧКА: Контекст -->
        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex flex-col justify-center">
            <h4 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-3">Контекст анализа</h4>
            <p class="text-gray-700 leading-relaxed">
                Мы сравнили ваш опрос с другими похожими анкетами по тегам:
            </p>
            <div class="flex flex-wrap gap-2 mt-3 mb-4">
                {% for tag in survey.tags %}
                <span class="px-3 py-1 bg-indigo-50 text-indigo-700 rounded-full text-xs font-bold border border-indigo-100">
                    #{{ tag.name }}
                </span>
                {% endfor %}
            </div>
            <p class="text-sm text-gray-500 italic">
                Данные «Рынка» — это усредненные показатели всех активных опросов, у которых есть хотя бы один из этих тегов.
            </p>
        </div>
    </div>

  

    <div class="space-y-8">
        {% for q in questions_stats %}
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b border-gray-100 pb-2">
                {{ loop.index }}. {{ q.text }}
                <span class="text-sm font-normal text-gray-400 ml-2">({{ q.type }})</span>
            </h3>

            {% if q.type in ['single_choice', 'multiple_choice', 'rating'] %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- График -->
                    <div id="chart-q-{{ q.id }}" class="h-64 w-full"></div>
                    
                    <!-- Таблица данных + Возраст -->
                    <div>
                        <table class="w-full text-sm text-left">
                            <thead class="text-gray-500 bg-gray-50 uppercase text-xs">
                                <tr>
                                    <th class="px-3 py-2">Вариант</th>
                                    <th class="px-3 py-2 text-right">Ответов</th>
                                    <th class="px-3 py-2 text-right">%</th>
                                    <th class="px-3 py-2 text-right text-purple-600" title="Средний возраст выбравших">Ср. Возраст</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                {% for label in q.data.labels %}
                                <tr>
                                    <td class="px-3 py-2 font-medium">{{ label }}</td>
                                    <td class="px-3 py-2 text-right">{{ q.data.counts[loop.index0] }}</td>
                                    <td class="px-3 py-2 text-right text-gray-500">{{ q.data.percentages[loop.index0] }}%</td>
                                    <td class="px-3 py-2 text-right font-bold text-purple-600">
                                        {{ q.data.avg_ages[loop.index0] or '-' }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Инициализация графика -->
                <script>
                    (function(){
                        // Подготовка данных
                        const rawLabels = {{ q.data.labels | tojson }};
                        const counts = {{ q.data.counts | tojson }};
                        
                        // Уменьшаем maxLen для более частого переноса (было 30 -> стало 25)
                        function wrapText(text, maxLen = 25) {
                            if (!text || text.length <= maxLen) return text;
                            const words = text.split(' ');
                            let line = '';
                            let result = '';
                            for (let w of words) {
                                if ((line + w).length > maxLen) {
                                    result += line.trim() + '<br>';
                                    line = '';
                                }
                                line += w + ' ';
                            }
                            return result + line.trim();
                        }
                        
                        const wrappedLabels = rawLabels.map(l => wrapText(l));

                        const data = [{
                            x: counts,
                            y: wrappedLabels,
                            type: 'bar',
                            orientation: 'h', 
                            marker: { color: '#3b82f6' },
                            text: counts.map(String),
                            textposition: 'auto',
                            hovertemplate: '<b>%{y}</b><br>Ответов: %{x}<extra></extra>'
                        }];
                        
                        // Увеличим множитель высоты, так как строк стало больше из-за <br>
                        const dynamicHeight = Math.max(250, rawLabels.length * 60 + 50);

                        const layout = {
                            margin: {
                                t: 10, 
                                l: 160, // УВЕЛИЧИЛИ ОТСТУП СЛЕВА
                                r: 20, 
                                b: 30
                            },
                            height: dynamicHeight,
                            yaxis: {
                                automargin: false, // Жесткий отступ
                                tickfont: {
                                    family: 'ui-sans-serif, system-ui, sans-serif',
                                    size: 12, // Компактный шрифт
                                    color: '#374151'
                                },
                            },
                            xaxis: {
                                automargin: true,
                                tickfont: { size: 10, color: '#9ca3af' },
                                gridcolor: '#f3f4f6',
                                zeroline: false
                            },
                            paper_bgcolor: 'rgba(0,0,0,0)',
                            plot_bgcolor: 'rgba(0,0,0,0)'
                        };

                        document.getElementById('chart-q-{{ q.id }}').style.height = dynamicHeight + 'px';
                        Plotly.newPlot('chart-q-{{ q.id }}', data, layout, {displayModeBar: false, responsive: true});
                    })();
                </script>

            {% elif q.type == 'text_answer' %}
                <div class="bg-gray-50 rounded-xl p-4 h-[300px] overflow-y-auto custom-scrollbar border border-gray-200">
                    {% if q.data %}
                        <div class="space-y-3">
                            {% for item in q.data %}
                            <div class="bg-white p-4 rounded-lg border border-gray-100 shadow-sm">
                                <p class="text-gray-800 text-sm leading-relaxed">
                                    "{{ item.text }}"
                                </p>
                                <p class="text-xs text-gray-400 mt-2 text-right">
                                    {% if item.date %}
                                        {{ item.date.strftime('%d.%m.%Y %H:%M') }}
                                    {% else %}
                                        Дата не указана
                                    {% endif %}
                                </p>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="flex items-center justify-center h-full text-gray-400">
                            Нет текстовых ответов.
                        </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}